var ZWaveRoutesPlotLib=function(){function e(b,d,f,m,e,g){g||(g=function(b){return b});return g((b-d)/(f-d))*(e-m)+m}function t(b,d,f){b=("00"+Math.round(e(b,d,f,64,255,Math.sqrt)).toString(16)).slice(-2);d=("00"+(64).toString(16)).slice(-2);return"#"+b+d+d}function y(l){switch(l){case "Controller":return b.color.controller;case "FLiRS":return b.color.flirs;case "Sleeping":return b.color.sleeping;case "Routing":return b.color.routing;default:throw"Unknow type:"+l;}}function h(b){this.zna=b;this.data=
{nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes()}var b={color:{selected:"darkred",current:"coral",routedFor:"sandybrown",association:"red",controller:"lightgray",flirs:"darkgreen",sleeping:"lightblue",routing:"black"},status:{dead:"Node is dead",alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};h.prototype.initPlot=function(){var b=d3.select("#svg");b.append("rect").style("fill","none").style("pointer-events",
"all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};h.prototype.initNodes=function(){function l(a){r();null===c.selectedNode?n(a):u(a);null===c.selectedNode||c.selectedNode===a?(d3.select("#ShowRepeatingFor").node().checked&&z(a.id),d3.select("#ShowNeighbours").node().checked&&v(a.id)):A(c.selectedNode.id,a.id);d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",b.color.current);w();d3.select("#ShowAssociations").node().checked&&
B(a.id)}function d(a){r();null!==c.selectedNode&&v(c.selectedNode);C();w();n(c.selectedNode);u()}function f(a){c.selectedNode=c.selectedNode===a?null:a;n(c.selectedNode)}function m(a){d3.event.active||p.alphaTarget(1).restart();a.fx=a.x;a.fy=a.y}function h(a){a.fx=d3.event.x;a.fy=d3.event.y}function g(a){d3.event.active||p.alphaTarget(0);a.fx=null;a.fy=null}function r(){d3.selectAll("line").attr("stroke",function(a){return t(a.rssi12,0,1)}).attr("stroke-width",function(a){return e(a.usage12,0,1,.3,
1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",d3.select("#ShowAllRoutes").node().checked?b.routes.othersOpacity:"0")}function v(a){d3.selectAll('line[id1="'+a+'"]').attr("opacity","1");d3.selectAll('line[id2="'+a+'"]').attr("opacity","1")}function A(a,b){var d=c.zna.getTrajectoryLinkMap(a,b);d3.selectAll("line").attr("stroke",function(a){return t(a.rssi12,0,1)}).attr("stroke-width",function(a){a=d.usage(a.source.id,a.target.id)+
d.usage(a.target.id,a.source.id);return e(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",function(a){return d.usage(a.source.id,a.target.id)+d.usage(a.target.id,a.source.id)?"1":"0"})}function C(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function w(){null!==c.selectedNode&&d3.selectAll('circle[id="id'+c.selectedNode.id+'"]').attr("fill",
b.color.selected)}function z(a){var c=this.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==c.indexOf(a.id)?b.color.routedFor:a.color})}function B(a){d3.selectAll("circle").filter(function(b){return-1!==c.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",b.color.association).attr("stroke-width",.2)}function n(a){d3.select("#annotation-src-id").html(a?a.id:"");d3.select("#annotation-src-name").html(a?a.name:"");d3.select("#annotation-src-type").html(a?a.type:
"");d3.select("#annotation-src-dead").html(a?a.dead?b.status.dead:b.status.alive:"");d3.select("#annotation-src-associations").html(a?c.zna.getNodeAssociations(a.id).join(", "):"");d3.select("#annotation-src-routes-for").html(a?c.zna.getNodesRoutedFor(a.id).join(", "):"")}function u(a){d3.select("#annotation-dst-id").html(a?a.id:"");d3.select("#annotation-dst-name").html(a?a.name:"");d3.select("#annotation-dst-type").html(a?a.type:"");d3.select("#annotation-dst-dead").html(a?a.dead?b.status.dead:
b.status.alive:"")}var c=this,p=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=e(a.usage,0,1,15,50,Math.sqrt)/8;a.color=y(a.type)});var k=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===k.length)k[0].x=b.viewport.sizeX/2,k[0].y=b.viewport.sizeY/2;else{var x=Math.min(b.viewport.sizeX,b.viewport.sizeY)/3,q=0;k.forEach(function(a){a.id===
c.zna.getMyNodeId()?a.x=a.y=0:(a.x=x*Math.cos(2*Math.PI/(k.length-1)*q),a.y=x*Math.sin(2*Math.PI/(k.length-1)*q),q++);a.x+=b.viewport.sizeX/2;a.y+=b.viewport.sizeY/2})}var D=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",function(a){return a.source.id}).attr("id2",function(a){return a.target.id}),E=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",
function(a){return"id"+a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",m).on("drag",h).on("end",g)).on("mouseover",l).on("mouseout",d).on("click",f),F=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline",
"middle").attr("transform",function(a){return"translate(0,0)"}).call(d3.drag().on("start",m).on("drag",h).on("end",g)).on("mouseover",l).on("mouseout",d).on("click",f);p.on("tick",function(){D.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});E.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});F.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})})};
return h}();
