window.ZWaveRoutesPlotLib=function(){function f(m,b,g,c,f,h){h||(h=function(b){return b});return h((m-b)/(g-b))*(f-c)+c}function w(b,c,g){b=("00"+Math.round(f(b,c,g,64,255,Math.sqrt)).toString(16)).slice(-2);c=("00"+(64).toString(16)).slice(-2);return"#"+b+c+c}function B(m){switch(m){case "Controller":return b.color.controller;case "FLiRS":return b.color.flirs;case "Sleeping":return b.color.sleeping;case "Routing":return b.color.routing;default:throw"Unknow type:"+m;}}function c(b){this.zna=b;this.data=
{nodes:this.zna.getNodes(),links:this.zna.getLinks()};this.selectedNode=null;this.initPlot();this.initNodes();this.nodesMoveAllowed=!1;3>this.data.nodes.length?d3.select("#IMA_too_few_nodes").style("display","block"):this.zna.getStats().haveIMA||d3.select("#IMA_absent").style("display","block")}var b={color:{selected:"darkred",current:"coral",routedFor:"sandybrown",association:"red",problematic:"orange",controller:"lightgray",flirs:"darkgreen",sleeping:"lightblue",routing:"black"},status:{dead:"Node is dead",
alive:"Node is alive"},routes:{othersOpacity:"0.3"},viewport:{sizeX:200,sizeY:100}};c.prototype.initPlot=function(){var b=d3.select("#svg");b.append("rect").style("fill","none").style("pointer-events","all");this.chartLayer=b.append("g").classed("chartLayer",!0).attr("width",1).attr("height",1).attr("transform","translate(0,0)")};c.prototype.initNodes=function(){function c(a){v();null===d.selectedNode?n(a):x(a);if(null===d.selectedNode||d.selectedNode===a)d3.select("#ShowRepeatingFor").node().checked&&
C(a.id),d3.select("#ShowNeighbours").node().checked&&y(a.id);else{D(d.selectedNode.id,a.id);var k=d.selectedNode.id,c=a.id;if(k==d.zna.getMyNodeId()){var e=d.zna.getTrajectoryStats(k,c);k=d.zna.getTrajectoryStats(c,k);d3.select("#annotation-src-dst-n-reroutes").html(isFinite(e.minOutHops)?Math.round(100*e.retries)/100+"%":"N/A");d3.select("#annotation-src-dst-num-hops").html(isFinite(e.minOutHops)?e.minOutHops!==e.maxOutHops?e.minOutHops+"&ndash;"+e.maxOutHops:e.minOutHops:"N/A");d3.select("#annotation-dst-src-explore-frames").html(Math.round(100*
k.explores)/100+"%");d3.select("#annotation-in-packets").html(k.received);d3.select("#annotation-out-packets").html(e.sent)}}d3.selectAll('circle[id="id'+a.id+'"]').attr("fill",b.color.current);z();d3.select("#ShowAssociations").node().checked&&E(a.id);d3.select("#ShowProblematic").node().checked&&F()}function r(a){v();null!==d.selectedNode&&y(d.selectedNode);G();z();n(d.selectedNode);x()}function g(a){d.selectedNode=d.selectedNode===a?null:a;n(d.selectedNode)}function t(a){d.nodesMoveAllowed&&(d3.event.active||
p.alphaTarget(1).restart(),a.fx=a.x,a.fy=a.y)}function u(a){d.nodesMoveAllowed&&(a.fx=d3.event.x,a.fy=d3.event.y)}function h(a){d.nodesMoveAllowed&&(0>a.x&&(a.x=0),0>a.y&&(a.y=0),200<a.x&&(a.x=200),100<a.y&&(a.y=100),d3.event.active||p.alphaTarget(0),a.fx=null,a.fy=null)}function v(){d3.selectAll("line").attr("stroke",function(a){return w(a.rssi12,0,1)}).attr("stroke-width",function(a){return f(a.usage12,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+Math.round(10*a.fails12).toString()}).attr("opacity",
d3.select("#ShowAllRoutes").node().checked?b.routes.othersOpacity:"0")}function y(a){d3.selectAll('line[id1="'+a+'"]').attr("opacity","1");d3.selectAll('line[id2="'+a+'"]').attr("opacity","1")}function D(a,b){var c=d.zna.getTrajectoryLinkMap(a,b);d3.selectAll("line").attr("stroke",function(a){return w(a.rssi12,0,1)}).attr("stroke-width",function(a){a=c.usage(a.source.id,a.target.id)+c.usage(a.target.id,a.source.id);return f(a,0,1,.3,1.7,Math.sqrt)}).attr("stroke-dasharray",function(a){return"2,"+
Math.round(10*a.fails12).toString()}).attr("opacity",function(a){return c.usage(a.source.id,a.target.id)+c.usage(a.target.id,a.source.id)?"1":"0"})}function G(){d3.selectAll("circle").attr("fill",function(a){return a.color}).attr("stroke",function(a){return a.color}).attr("stroke-width","0px")}function z(){null!==d.selectedNode&&d3.selectAll('circle[id="id'+d.selectedNode.id+'"]').attr("fill",b.color.selected)}function C(a){var c=d.zna.getNodesRoutedFor(a);d3.selectAll("circle").attr("fill",function(a){return-1!==
c.indexOf(a.id)?b.color.routedFor:a.color})}function E(a){d3.selectAll("circle").filter(function(b){return-1!==d.zna.getNodeAssociations(a).indexOf(b.id)}).attr("stroke",b.color.association).attr("stroke-width",.2)}function F(){var a=d.zna.getMyNodeId();d3.selectAll("circle").filter(function(b){var c=d.zna.getTrajectoryStats(a,b.id);b=d.zna.getTrajectoryStats(b.id,a);return 0<c.retries||0<b.explores}).attr("stroke",b.color.problematic).attr("stroke-dasharray",[1,1]).attr("stroke-width",.5)}function n(a){d3.select("#annotation-src-id").html(a?
a.id:"");d3.select("#annotation-src-name").html(a?a.name:"");d3.select("#annotation-src-type").html(a?a.type:"");d3.select("#annotation-src-dead").html(a?a.dead?b.status.dead:b.status.alive:"");d3.select("#annotation-src-associations").html(a?d.zna.getNodeAssociations(a.id).join(", "):"");d3.select("#annotation-src-routes-for").html(a?d.zna.getNodesRoutedFor(a.id).join(", "):"")}function x(a){d3.select("#annotation-dst-id").html(a?a.id:"");d3.select("#annotation-dst-name").html(a?a.name:"");d3.select("#annotation-dst-type").html(a?
a.type:"");d3.select("#annotation-dst-dead").html(a?a.dead?b.status.dead:b.status.alive:"")}var d=this,p=d3.forceSimulation(this.data.nodes).force("linkForce",d3.forceLink(this.data.links).id(function(a){return a.id}).distance(function(a){return 400}).strength(0));this.data.nodes.map(function(a){a.r=f(a.usage,0,1,15,50,Math.sqrt)/8;a.color=B(a.type)});var l=this.data.nodes.filter(function(a){return null===a.x||null===a.y});if(1===l.length)l[0].x=b.viewport.sizeX/2,l[0].y=b.viewport.sizeY/2;else{var A=
Math.min(b.viewport.sizeX,b.viewport.sizeY)/3,q=0;l.forEach(function(a){a.id===d.zna.getMyNodeId()?a.x=a.y=0:(a.x=A*Math.cos(2*Math.PI/(l.length-1)*q),a.y=A*Math.sin(2*Math.PI/(l.length-1)*q),q++);a.x+=b.viewport.sizeX/2;a.y+=b.viewport.sizeY/2})}var H=this.chartLayer.append("g").attr("class","links").selectAll("line").data(this.data.links).enter().append("line").attr("id1",function(a){return a.source.id}).attr("id2",function(a){return a.target.id}),I=this.chartLayer.append("g").attr("class","nodes").selectAll("circle").data(this.data.nodes).enter().append("circle").attr("id",
function(a){return"id"+a.id}).attr("r",function(a){return a.r}).attr("fill",function(a){return a.color}).attr("mask",function(a){return a.dead?"url(#mask)":""}).call(d3.drag().on("start",t).on("drag",u).on("end",h)).on("mouseover",c).on("mouseout",r).on("click",g),J=this.chartLayer.append("g").attr("class","labels").selectAll("text").data(this.data.nodes).enter().append("text").text(function(a){return a.id}).attr("font-size",2).attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline",
"middle").attr("transform",function(a){return"translate(0,0)"}).call(d3.drag().on("start",t).on("drag",u).on("end",h)).on("mouseover",c).on("mouseout",r).on("click",g);p.on("tick",function(){H.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});I.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});J.attr("x",function(a){return a.x}).attr("y",function(a){return a.y})})};
c.prototype.allowMoveNodes=function(b){void 0!=b&&(this.nodesMoveAllowed=!this.nodesMoveAllowed);return this.nodesMoveAllowed};c.prototype.getNodesPositions=function(){return this.data.nodes.map(function(b){return{id:b.id,x:b.x,y:b.y}})};return c}();window.ZWaveRoutesPlotLib.prototype.getNodesPositions=window.ZWaveRoutesPlotLib.prototype.getNodesPositions;window.ZWaveRoutesPlotLib.prototype.allowMoveNodes=window.ZWaveRoutesPlotLib.prototype.allowMoveNodes;