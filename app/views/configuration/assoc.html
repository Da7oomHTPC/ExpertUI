<!-- Association view -->
<div id="AssociationTable" ng-controller="ConfigAssocController">
    <!-- Config navigation -->
    <div ng-include="'app/views/configuration/header.html'"></div>

    <div class="tab-content" ng-show_="deviceId > 0">
        <div class="page-header"><h1 class="text-danger">{{ _t('associations_list')}} !!! DEV !!!</h1></div>
        
        <button 
            type="button" 
            class="btn btn-primary spin-true"
            id="btn_update_from_device"
            ng-click="updateFromDevice('#btn_update_from_device')" 
            >{{_t('update_from_device')}} <i class="fa fa-spinner fa-spin"></i></button>
        <br/><br/>
        <!-- ////////////////////////////////////////////////////////////////////////////////////// -->
        <!-- Assoc design -->
         <p class="text-danger text-alert-list" ><i class="fa fa-exclamation-triangle"></i>  {{_t('device_changed_configuration')}}</p>
        <div class="table-responsive"> 
            <table class="table table-striped_ table-condensed">
                <tbody>
                    <tr ng-repeat="v in assocGroups">
                        <td class="association-text"> 
                            <h5>
                                {{v.label}} ({{ _t('assoc_max')}} {{v.max}} {{ _t('assoc_nodes')}}) 
                                <span> | <i class="fa fa-clock-o"></i> <span ng-class="v.updateTime < v.invalidateTime ? 'red': ''">{{v.updateTime| isTodayFromUnix}}</span></span> <!--updateTime: {{v.updateTime |dateFromUnix}}, invalidateTime: {{v.invalidateTime|dateFromUnix}}-->
                            </h5>
                            
                            <div>
                                <div class="btn-group btn-group-assoc-devices {{d.status}}" role="group" ng-repeat="d in assocGroupsDevices[v.groupId]" id="assoc_device_{{v.groupId}}_{{d.id}}">
                                <button type="button" class="btn btn-info" title="{{d.name}}">
                                   <!--inDevice: {{d.inDevice}}  | inConfig: {{d.inConfig}}--> | Status: {{d.status}}
                                    <i class="fa fa-exclamation-triangle text-danger_" ng-if="d.status !== 'true-true'"></i> 
                                    {{_t('txt_device')}} (#{{d.id}}<span ng-if="d.instance != null">.{{d.instance}}</span>)
                                </button>
                                <button type="button" class="btn btn-primary" ng-click="deleteAssoc(d,v.groupId,d.id,'assoc_device_' + v.groupId + '_' + d.id)">
                                    <i class="fa fa-times text-danger"></i>
                                </button>
                                <!--<br ng_if="$index % 5 == 4"/> -->
                            </div>
                            </div>
                            
                        </td>
                        <td  class="association-action" style="text-align: right; width: 20%;"> 
                            <button type="button" class="btn btn-primary" 
                                    data-toggle="modal" data-ng-click="openAdd(data[key])" data-target="#modal_add" ng-disabled="data[key].max <= data[key].nodeIds.length"><span style="display: inline-block;width:12px;">+</span></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- ////////////////////////////////////////////////////////////////////////////////////// -->

        <!-- Modal remove -->
        <div class="modal fade" id="modal_remove" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{{ _t('assoc_confirm_remove')}}</h4>
                    </div>
                    <div class="modal-body" style="white-space: normal;">
                        <div class="form-inline">
                            <div class="form-group">
                                <!--<select ng-model="assocToNode" class="form-control" ng-options="k as v for (k,v) in removeNodes">
                                    <option value="">&lt; {{ _t('assoc_select_to_node')}} {{$index}}&gt;</option>
                                </select>-->
                                <select ng-model="assocToNode" class="form-control">
                                    <option value="">&lt; {{ _t('assoc_select_to_node')}} &gt;</option>
                                    <option ng-repeat="v in removeNodesSort| orderBy:'key'" value="{{v.key}}" ng-selected="v.key == assocToNode">{{v.val}}</option>
                                </select>
                            </div>
                            <div class="form-group" ng-show="removeInstances[assocToNode] != undefined">

                                <!--<select ng-model="assocToInstance" ng-init="assocToInstance = 1" class="form-control" ng-options="k as v for (k,v) in removeInstances[assocToNode]">
                                   <option value="">&lt; {{ _t('assoc_select_to_instance')}} &gt;</option>
                               </select>-->

                                <select ng-model="assocToInstance" class="form-control">
                                    <option value="" ng-hide_="(removeInstances[assocToNode] | getObjectLength) == 1">&lt; {{ _t('assoc_select_to_instance')}} &gt;</option>
                                    <option ng-repeat="(k,v) in removeInstances[assocToNode]" value="{{k}}" ng-init="assocToInstance = (removeInstances[assocToNode] | getObjectLength) == 1 ? (removeInstances[assocToNode] | getFirstObjectKey) : ''" ng-selected="k == assocToInstance">{{v}}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" ng-click="closeRemove()">{{ _t('dialog_abort')}}</button>
                        <button class="btn btn-primary update" data-ng-click="remove()" ng-disabled="assocToNode == '' || ((removeInstances[assocToNode] != undefined) && (removeInstances[assocToNode] | getObjectLength) != 1 && assocToInstance == '')">{{ _t('dialog_remove')}}</button>
                    </div>
                </div>
            </div>
        </div><!-- /.Modal -->
        <!-- Modal add -->
        <div class="modal fade" id="modal_add" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">{{ _t('assoc_add_title')}}</h4>
                    </div>
                    <div class="modal-body" style="white-space: normal;"> 
                        <div class="form-inline">
                            {{ _t('fro')}} {{addData.nodeId| deviceName:addData.node}} {{ _t('to_locate')}} <br/>
                            <div class="form-group">
                                <!--<select ng-model="assocToNode" class="form-control" ng-options="k as v for (k,v) in addNodes">
                                   <option value="">&lt; {{ _t('assoc_select_to_node')}} &gt;</option>
                               </select>-->
                                <select ng-model="assocToNode" class="form-control">
                                    <option value=""  ng-selected="true">&lt; {{ _t('assoc_select_to_node')}} &gt;</option>
                                    <option ng-repeat="v in addDevices" value="{{v.key}}">{{v.val}}</option>
                                </select>
                            </div>
                            <div class="form-group" ng-show="addInstances[assocToNode] != undefined">
                                <select ng-model="assocToInstance" class="form-control" ng-options="k as v for (k,v) in addInstances[assocToNode]">
                                    <option value="">&lt; {{ _t('assoc_select_to_instance')}} &gt;</option>
                                </select>
                            </div> 
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{{ _t('dialog_abort')}}</button>
                        <button class="btn btn-primary update assocAdd" data-ng-click="add()" ng-disabled="assocToNode == null || ((addInstances[assocToNode] != undefined) && assocToInstance == null)">{{ _t('dialog_add')}}</button>
                    </div> 
                </div>
            </div>
        </div><!-- /.Modal -->
    </div> 
</div><!-- /ng-controler -->
